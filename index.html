<!-- Firebase SDK -->
<!-- Firebase v9 (compat mode) for HTML script support -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>


<script>
  // ðŸ”§ Replace this config with YOUR Firebase project config
  const firebaseConfig = {
    apiKey: "AIzaSyDV9ASRzlNYcOmo6zYNo5_f-svsCJljqbA",
    authDomain: "gcw-timetable.firebaseapp.com",
    databaseURL: "https://gcw-timetable-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "gcw-timetable",
    storageBucket: "gcw-timetable.firebasestorage.app",
    messagingSenderId: "654415403426",
    appId: "1:654415403426:web:7651a0a730ac20186a3afb"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  async function fetchSchedule() {
    const rollNo = document.getElementById("rollNo").value.trim();
    const output = document.getElementById("output");
    output.style.display = 'block';

    if (!rollNo) {
      alert("Please enter a roll number.");
      return;
    }

    output.innerHTML = "Loading...";

    try {
      const studentSnap = await db.ref(`Student/${rollNo}`).once('value');
      if (!studentSnap.exists()) {
        output.innerHTML = `<p style="color: red;">No student found for Roll No: ${rollNo}</p>`;
        return;
      }

      const student = studentSnap.val();
      const subjectSectionPairs = [];

      for (let i = 1; i <= 8; i++) {
        const sub = student[`sub${i}`];
        const sec = student[`sec${i}`];
        if (sub && sec) {
          subjectSectionPairs.push(`${sub}|${sec}`);
        }
      }

      const ttSnap = await db.ref("FlattenedTT").once('value');
      const allTT = Object.values(ttSnap.val() || {});

      const matched = allTT.filter(row =>
        subjectSectionPairs.includes(`${row.subject}|${row.section}`)
      );

      if (matched.length === 0) {
        output.innerHTML = `<p>No matching timetable entries found for ${student.name}.</p>`;
        return;
      }

      let html = `<h3>Schedule for ${student.name}</h3>`;
      html += `
        <table>
          <tr>
            <th>Class</th>
            <th>Time Slot</th>
            <th>Subject</th>
            <th>Section</th>
            <th>Days</th>
            <th>Teacher</th>
            <th>Room No.</th>
          </tr>
      `;

      matched.forEach(row => {
        html += `
          <tr>
            <td>${row.class || ''}</td>
            <td>${row.time || ''}</td>
            <td>${row.subject || ''}</td>
            <td>${row.section || ''}</td>
            <td>${row.days || ''}</td>
            <td>${row.teacher || ''}</td>
            <td>${row.room || ''}</td>
          </tr>
        `;
      });

      html += "</table>";
      output.innerHTML = html;

    } catch (err) {
      console.error("Error fetching data:", err);
      output.innerHTML = "<p style='color:red;'>Error fetching timetable. Please try again later.</p>";
    }
  }
</script>
